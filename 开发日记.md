#                                            开发日记

### 2025-5-18

#### 信息格式

```c++
 QString account =ui->accountEdit->text();
    QString password =ui->passwordEdit->text();
    QString accInfo =QString("account:%1 password:%2").arg(account,password);
```

#### 从账号信息中提取账号和密码

```cpp
QRegularExpression re("account:(.+?) password:(.+)");
QRegularExpressionMatch match =re.match(accInfo);
if(match.hasMatch()){
    qDebug()<<match.captured(1);
    qDebug()<<match.captured(2);
}
```

#### 服务端监听与数据库连接

```c++
server = new QTcpServer;
server->listen(QHostAddress::AnyIPv4,8000);

db =QSqlDatabase ::addDatabase("QMYSQL");
db.setDatabaseName("mydb");
db.setHostName("localhost");
db.setUserName("root");
db.setPassword("root");
if(db.open()){
    QMessageBox::information(this,"提示","数据库连接成功");
}else{
    QMessageBox::information(this,"提示","数据库连接失败");
}
```

#### 实现当同意协议时才可登录

```c++
void MainWindow::on_aggreButton_clicked()
{
    //登录按钮的变色逻辑
    if(ui->aggreButton->isChecked()){
        ui->LogButton->setStyleSheet("background-color: rgb(0, 170, 255);");
        ui->LogButton->setEnabled(1);
    }else{
         ui->LogButton->setStyleSheet("background-color: rgb(170, 233, 255);");
        ui->LogButton->setEnabled(0);
    }
}
```

#### 拖动事件的处理

```c++
bool DragEvent::eventFilter(QObject* object,QEvent* event){
    auto m =dynamic_cast<QMainWindow*>(object);
    if(!m){
        return false;
    }
    if(event->type()==QEvent::MouseButtonPress){
        auto e =dynamic_cast<QMouseEvent*>(event);
        if(!e)return false;
        mousePoint=e->pos();//记录鼠标按下位置
    }else if(event->type()==QEvent::MouseMove){
        auto e=dynamic_cast<QMouseEvent*>(event);
        if(!e)return false;
        if(e->buttons()&Qt::MouseButton::LeftButton){
            m->move(e->globalPosition().toPoint()-mousePoint);
        }
    }
    return QObject::eventFilter(object,event);
}
```

#### 数据库的构建

```sql

create table users(

  id int primary key auto_increment,

  account varchar(20) not null unique,

  password varchar(20) not null

);

create table friendships(

  id int primary key auto_increment,

  user_id int not null,

  friend_id int not null,

  foreign key(user_id) references users(id)
);
```

#### 用户数据的插入

```c++
QSqlQuery query;
query.prepare("INSERT INTO users (account, password) VALUES (:account, :password)");

// 绑定参数
query.bindValue(":account", account);
query.bindValue(":password", password);

if (query.exec()) {
    QString successMessage = QString("Registration successful: Account: %1").arg(account);
    ui->messageList->addItem(successMessage);
    QJsonObject response;
    response["type"] = "register_response";
    response["status"] = "success";
    response["message"] = "Registration successful";
    QByteArray responseData = QJsonDocument(response).toJson();
    socket->write(responseData);
} else {
    QString errorMessage = QString("Registration failed: Account: %1, Error: %2")
        .arg(account, query.lastError().text());
    ui->messageList->addItem(errorMessage);
    QJsonObject response;
    response["type"] = "register_response";
    response["status"] = "failure";
    response["message"] = query.lastError().text();
    QByteArray responseData = QJsonDocument(response).toJson();
    socket->write(responseData);
}
```

### 客户端对注册信息的处理

```c++
if(type=="register_response"){
    if(jsonObject.value("status").toString()=="success")
        QMessageBox::information(this,"提示","注册成功");
    else
        QMessageBox::warning(this,"提示","注册失败");
}
```

### 服务端登录处理



```c++
if(type=="login"){
    QString account = jsonObject.value("account").toString();
    QString password = jsonObject.value("password").toString();
    QString Seip =jsonObject.value("senderIp").toString();
    QString Seport=jsonObject.value("senderPort").toString();
    QString message = QString("Login request: Account: %1, Password: %2 "
                              "IP: %2, PORT: %4").arg(account, password,Seip,Seport);        
    ui->messageList->addItem(message);
    QSqlQuery query;
    query.prepare("SELECT password FROM users WHERE account = :account");
    query.bindValue(":account", account);

    if(query.exec()){
        response["type"] = "login_response";//消息类型
        if(query.next()){
            QString storePassword =query.value(0).toString();
            if(storePassword==password){
                //密码正确
                response["status"] = "success";
                response["message"] = "Login successful";
            }else{
                //密码错误
                response["status"] = "failure";
                response["message"] = "Incorrect password";
            }
        }else{
            //无账号
            response["status"] = "failure";
            response["message"] = "Account not found";
        }
    }
    QString Logmessage=QString("%1, result:%2").arg(message,response.value("message").toString());
    ui->messageList->addItem(Logmessage);
    //返回登录信息
    responseData = QJsonDocument(response).toJson();
    socket->write(responseData);
```
